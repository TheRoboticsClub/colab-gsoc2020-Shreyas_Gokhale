<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="p:domain_verify" content="74b28158c46b8035f8f4a5ba032e51b2" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="GSoC 2020 | Shreyas Gokhale" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="GSoC 2020 | Shreyas Gokhale" /> <title> Behaviour Trees - GSoC 2020 | Shreyas Gokhale </title> <link rel="alternate" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/behaviour-trees" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/behaviour-trees" /> <meta name="description" content="Custom Navigation2" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Behaviour Trees | shreyasgokhale" /> <meta property="og:title" content="Behaviour Trees | shreyasgokhale" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/behaviour-trees" /> <meta property="og:description" content="Custom Navigation2" /> <meta property="og:image" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Behaviour Trees | shreyasgokhale" /> <meta name="twitter:url" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/behaviour-trees" /> <meta name="twitter:site" content="@shreyasgokhale" /> <meta name="twitter:creator" content="@shreyasgokhale" /> <meta name="twitter:description" content="Custom Navigation2" /> <meta name="twitter:image" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/feed.xml" title="GSoC 2020 | Shreyas Gokhale" /> <link rel="apple-touch-icon" sizes="180x180" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="ShreyasGokhale" /> <meta name="application-name" content="ShreyasGokhale" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/colab-gsoc2020-Shreyas_Gokhale/assets/css/style.css" /> </head> <body> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mood"> <svg class="mood-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mood-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"> <a class="menu-link" href="/colab-gsoc2020-Shreyas_Gokhale">home</a> <a class="menu-link" href="/colab-gsoc2020-Shreyas_Gokhale/about/">about author</a> <a class="menu-link" href="https://www.notion.so/shreyasgokhale/GSoC-JdeRobot-ff2c6cf65b3f4a488ca0af77e1daeff1" target="_blank" rel="noopener" >GSoC dashboard</a > <a class="menu-link" href="https://jderobot.github.io/" target="_blank" rel="noopener" >jderobot academy</a > <a class="menu-link" href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale" target="_blank" rel="noopener" >github repo</a > <a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#amazon-warehouse-robot">AMAZON-WAREHOUSE-ROBOT</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#exercise">EXERCISE</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#gazebo">GAZEBO</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#ros2">ROS2</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#nav2">NAV2</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#joint">JOINT</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#week-11">WEEK-11</a> </span> </div> <h1 class="header-title" itemprop="headline">Behaviour Trees</h1> <div class="post-meta"> <time datetime="2020-08-17T13:30:00+02:00" itemprop="datePublished"> Aug 17, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Shreyas Gokhale</span> </span> <time hidden datetime="" itemprop="dateModified"> Aug 17, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Shreyas Gokhale</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><blockquote> <p>Issues Pending:</p> <p><a href="https://github.com/ros-planning/navigation2/issues/1933">#1933</a> Nav2 local_costmap crash issues</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/11">#11</a> Separate Action server for issuing action commands for robot controller</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/9">#9</a> Multi Robot Discussion</p> <p>Issues Solved:</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/12">#12</a> Creating a framework to add new new functionality with Nav2</p> </blockquote> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <blockquote> <p>Issues Pending:</p> <p><a href="https://github.com/ros-planning/navigation2/issues/1933">#1933</a> Nav2 local_costmap crash issues</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/11">#11</a> Separate Action server for issuing action commands for robot controller</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/9">#9</a> Multi Robot Discussion</p> <p>Issues Solved:</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/12">#12</a> Creating a framework to add new new functionality with Nav2</p> </blockquote> <h1 id="week-11-blog"> <a href="#week-11-blog" class="anchor-head"></a> Week 11 Blog </h1> <p>The last week was certainly one of the most happening ones (and in my opinion, the most challenging one) The joy you get when your code works after endless hours of debugging is amazing, but sadly that didnâ€™t last long. Although we have everything ready which we need, the navigation2 integration has some creases which we need to iron out.</p> <p>Before we go to the development part of our exercise, I want you to get a feel of how it is working. So lets do a quick dry run.</p> <h2 id="dry-run"> <a href="#dry-run" class="anchor-head"></a> Dry run </h2> <p>Start by cloning the repo. If you are debugging, you can use <code class="highlighter-rouge">foxy-devel</code> branch of <a href="https://github.com/shreyasgokhale/CustomRobots.git"><code class="highlighter-rouge">https://github.com/shreyasgokhale/CustomRobots.git</code></a> . But if you just want to see how everything is working, clone <a href="https://github.com/shreyasgokhale/Amazon-Robot.git"><code class="highlighter-rouge">https://github.com/shreyasgokhale/Amazon-Robot.git</code></a> and run</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xhost +<span class="s2">"local:docker@"</span> 
docker-compose up <span class="nt">--build</span>
</code></pre></div></div> <p>This fetches everything using docker and runs <code class="highlighter-rouge">amazon_warehouse_world.py</code> launch file. To make it easier, everything is organised from our bringup directory. This file, launches other files and nodes and so on. In the end you will see the familiar RViz and Gazebo Windows. It will take a while to load, have some patience ðŸ˜…. Finally, once everything is ready, localize our robot in approximate position of the map.</p> <p><img src="assets/blog-images/week-11/UninitalizedRViz.png" alt="Uninitalized RVIZ" /></p> <p>Click on <code class="highlighter-rouge">2D Pose estimate</code> button and estimate our pose on the map. Approximate is fine. This will initialize our nav stack. Then, click on <code class="highlighter-rouge">waypoint mode</code> and estimate the pose again. This time, it will initialize our plugin. Then, set your pickup and dropoff points using <code class="highlighter-rouge">Navigation Goal</code> button and click on <code class="highlighter-rouge">Start Navigation</code></p> <p><img src="assets/blog-images/week-11/SetNav.gif" alt="Gazebo" /></p> <p><img src="assets/blog-images/week-11/gazebo.png" alt="Gazebo" /></p> <p>The robot will start moving. When it reaches our first goal point, it will actuate the lift joint to <code class="highlighter-rouge">Load</code> position- making the pallet loaded on the robot. It will go on to the next point and unload the pallet.</p> <div class="embed-container"> <iframe src="https://www.youtube.com/embed/F1WELXcg364" width="700" height="480" frameborder="0" allowfullscreen=""> </iframe> </div> <p>Is your robot stuck and never reaches the goal? That is because we donâ€™t have a costmap! Why you ask? There is a bug in the repo which crashes the controller when we have a working local costmap! We are trying to fix it soon.</p> <p>Okay, what just happened? For that, we need to understand what are behaviour trees and how our code is structured.</p> <h2 id="understanding-the-core-structure"> <a href="#understanding-the-core-structure" class="anchor-head"></a> Understanding the core structure </h2> <p>Letâ€™s start with design choices that we had for making our use case.</p> <ol> <li><strong>The quick and easy (but not ideal) one:</strong> We can use the <code class="highlighter-rouge">NavigateToPose</code> action supplied by Navigation2 to just send goals to the robots. Then we handle everything else (loading pallets, planning) in our central planner by issuing commands to each robot. This is not a bad choice, but we donâ€™t leverage the capabilities of behaviour trees in this case.</li> <li><strong>The not-so-quick (and easy) one:</strong> Creating our custom behaviour tree nodes paired with the plugins and node behaviours. We can leverage <code class="highlighter-rouge">NavigateToPose</code> behaviour tree node in order to create even a bigger behaviour tree. We can expand this with various conditional and decision nodes in additions to the action plugins, making it even more complex. This way, we can embed our robot behaviour in the tree itself. But this is <em>significantly</em> more convoluted in terms of software.</li> </ol> <p>As our repo will be used as a reference to create more ROS2 navigation Robots and behaviours, we decided to go with the second one. Now summing all of our previous developments (blogs <a href="https://theroboticsclub.github.io/colab-gsoc2020-Shreyas_Gokhale/two-x">2x</a> and <a href="https://theroboticsclub.github.io/colab-gsoc2020-Shreyas_Gokhale/finding-the-way">Finding The Way</a> ), we can define a final end goals for our system:</p> <ol> <li>A self contained amazon robot package which includes all the gazebo worlds, models, launch files, navigation controllers, plugins and other necessary components to be able to launch a complete amazon warehouse scenario.</li> <li>The warehouse scenario can demonstrate loading up of pallets from pick up zones and placing them in the drop off zones. Our custom robot uses itâ€™s lift joint which actuates using gazebo services for loading.</li> <li>The behaviours of robot: loading, drop-off, navigating, recovering from situations are all explained using behaviour trees: which we can edit, modify, and change according to our scenario.</li> </ol> <p><a href="https://github.com/ros-planning/navigation2/tree/master/nav2_behavior_tree">nav2_behaviour_tree</a> is the template package which offers a way of including externally created behaviour trees into navigation2. We will be leveraging the <code class="highlighter-rouge">NavigateToPose</code> node of behaviour tree to include it in our own behaviour tree and node packages. This node will be called as <code class="highlighter-rouge">FollowTargets</code> . If you also want to create you own custom behaviours depending on Navigation2, then following writeup might also help you. So letâ€™s begin,</p> <h2 id="creating-followtargets-and-corresponding-nodes"> <a href="#creating-followtargets-and-corresponding-nodes" class="anchor-head"></a> Creating <code class="highlighter-rouge">FollowTargets</code> and corresponding nodes </h2> <p>In order to create our very own node, we need 3 things:</p> <ol> <li>ROS2 action corresponding to our node</li> <li>Behaviour tree which implements this node</li> <li>C++ source and header files showcasing its usage.</li> </ol> <p>But what controls the robot? In our case, this will be done by a common task planner. This centralised planner will issue tasks to the robot and will keep a track of things.</p> <p>Donâ€™t get confused! We have an action server representing our robotâ€™s <code class="highlighter-rouge">FollowTarget</code> action. This makes our planner an action client for the robot. But in big order of things, our robot is essentially a service to the centralized planner and it is the centralized planner who calls the shots. Hence, architecturally, the planner <em>acts</em> as a server which issues goals for our robot. For starting out, we will be using rviz plugins for our action client but the task of the reader is to implement one by their own.</p> <p>This <code class="highlighter-rouge">FollowTarget</code> node will accept list of poses and their corresponding load/unload action as an input.( see action message) The string will dictate what action we have to perform (= load or unload). As we evolve our application further, we will include more complex behaviours such as different actions and ability to add stops. For now, we already have a quite a lot to do.</p> <h3 id="amazon-robot-controller"> <a href="#amazon-robot-controller" class="anchor-head"></a> Amazon Robot Controller </h3> <p>Controller is heart of our operations. It is, in essence, an action server which works with our behaviour trees. Also, it is a lifecycle node in ROS2 terms which is managed by <code class="highlighter-rouge">nav2_lifecycle_manager</code>. These nodes start as unconfigured and they have different stages of operation. At times, for example <code class="highlighter-rouge">on_activate</code> or <code class="highlighter-rouge">on_destoy</code> , appropriate functions are called to felicitate the cause. Our robot controller also registers our <code class="highlighter-rouge">FollowTarget</code> action server.</p> <p>For our custom behaviours, we will be implementing our own plugins. Consider the example of one such implemented plugin: <code class="highlighter-rouge">LoadPallet</code> . In <code class="highlighter-rouge">amazon_robot/amazon_robot_controller/plugins/action/load_pallet.cpp</code> , you will find the code related the plugin. It is called in the way our behaviour tree is arranged in <code class="highlighter-rouge">amazon_robot/amazon_robot_controller/behavior_trees/follow_waypoints_and_load.xml</code></p> <p><em>To Be Continuedâ€¦</em></p> <p><strong><em>Eis to epanideÃ­n!</em></strong></p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/colab-gsoc2020-Shreyas_Gokhale/two-x" > <div class="nav-arrow">Previous</div> <span class="post-title">2x !</span> </a> <a class="post-nav-item post-nav-next" href="/colab-gsoc2020-Shreyas_Gokhale/jde-multibot"> <div class="nav-arrow">Next</div> <span class="post-title">JdeMultibot</span> </a> </nav> </div> <footer class="footer"> <a class="footer_item" href="https://github.com/shreyasgokhale">github</a> <a class="footer_item" href="https://www.linkedin.com/in/shreyas6gokhale/">linkedin</a> <a class="footer_item" href="https://www.instagram.com/elementaryshr/">instagram</a> <a class="footer_item" href="https://shreyasgokhale.com/">blog</a> <a class="footer_item" href="https://www.shreyasgokhaleresu.me/">portfolio</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2020</span> <small class="footer_theme-copyright"> <!-- KlisÃ© Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisÃ©</a> theme | modified by <a href="https://shreyasgokhale.com/" target="_blank" rel="noreferrer noopener" >shreyas</a> </small> </footer> <script src="/colab-gsoc2020-Shreyas_Gokhale/assets/js/main.js" defer="defer"></script> <script src="/colab-gsoc2020-Shreyas_Gokhale/assets/js/galite.js"></script> <script> var galite = galite || {}; galite.UA = "UA-126403543-4"; </script> </body> </html>
