<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="p:domain_verify" content="74b28158c46b8035f8f4a5ba032e51b2" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="GSoC 2020 | Shreyas Gokhale" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="GSoC 2020 | Shreyas Gokhale" /> <title> JdeMultibot - GSoC 2020 | Shreyas Gokhale </title> <link rel="alternate" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/jde-multibot" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/jde-multibot" /> <meta name="description" content="ROS2 Multi Robot Amazon Warehouse exercise with navigation2, planner and lift." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="JdeMultibot | shreyasgokhale" /> <meta property="og:title" content="JdeMultibot | shreyasgokhale" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/jde-multibot" /> <meta property="og:description" content="ROS2 Multi Robot Amazon Warehouse exercise with navigation2, planner and lift." /> <meta property="og:image" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="JdeMultibot | shreyasgokhale" /> <meta name="twitter:url" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/jde-multibot" /> <meta name="twitter:site" content="@shreyasgokhale" /> <meta name="twitter:creator" content="@shreyasgokhale" /> <meta name="twitter:description" content="ROS2 Multi Robot Amazon Warehouse exercise with navigation2, planner and lift." /> <meta name="twitter:image" content="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/colab-gsoc2020-Shreyas_Gokhale/feed.xml" title="GSoC 2020 | Shreyas Gokhale" /> <link rel="apple-touch-icon" sizes="180x180" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/colab-gsoc2020-Shreyas_Gokhale/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="ShreyasGokhale" /> <meta name="application-name" content="ShreyasGokhale" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/colab-gsoc2020-Shreyas_Gokhale/assets/css/style.css" /> </head> <body> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mood"> <svg class="mood-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mood-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"> <a class="menu-link" href="/colab-gsoc2020-Shreyas_Gokhale">home</a> <a class="menu-link" href="/colab-gsoc2020-Shreyas_Gokhale/about/">about author</a> <a class="menu-link" href="https://www.notion.so/shreyasgokhale/GSoC-JdeRobot-ff2c6cf65b3f4a488ca0af77e1daeff1" target="_blank" rel="noopener" >GSoC dashboard</a > <a class="menu-link" href="https://jderobot.github.io/" target="_blank" rel="noopener" >jderobot academy</a > <a class="menu-link" href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale" target="_blank" rel="noopener" >github repo</a > <a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#amazon-warehouse-robot">AMAZON-WAREHOUSE-ROBOT</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#multirobot">MULTIROBOT</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#exercise">EXERCISE</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#gazebo">GAZEBO</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#ros2">ROS2</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#nav2">NAV2</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#joint">JOINT</a>, <a class="tag" href="/colab-gsoc2020-Shreyas_Gokhale/tags/#week-12">WEEK-12</a> </span> </div> <h1 class="header-title" itemprop="headline">JdeMultibot</h1> <div class="post-meta"> <time datetime="2020-08-27T01:00:00+02:00" itemprop="datePublished"> Aug 27, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Shreyas Gokhale</span> </span> <time hidden datetime="" itemprop="dateModified"> Aug 27, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Shreyas Gokhale</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><blockquote> <p>Issues Solved:</p> <p><a href="https://github.com/ros-planning/navigation2/issues/1933">#1933</a> Nav2 local_costmap crash issues</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/11">#11</a> Separate Action server for issuing action commands for robot controller</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/9">#9</a> Multi Robot Discussion</p> </blockquote> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <blockquote> <p>Issues Solved:</p> <p><a href="https://github.com/ros-planning/navigation2/issues/1933">#1933</a> Nav2 local_costmap crash issues</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/11">#11</a> Separate Action server for issuing action commands for robot controller</p> <p><a href="https://github.com/TheRoboticsClub/colab-gsoc2020-Shreyas_Gokhale/issues/9">#9</a> Multi Robot Discussion</p> </blockquote> <h1 id="week-12-blog"> <a href="#week-12-blog" class="anchor-head"></a> Week 12 Blog </h1> <p>After ~12 weeks of non-stop code marathon, we have now arrived at the very last leg of the GSoC journey. The goal of this summer: <em>“To create a multirobot exercise in ROS2”</em> is now almost achieved. This week, we will dive into the nitty gritty details of our code, how ROS2 and Navigation2 are configured and all the things that you need to know before you can start working on solving the exercises. This week’s post will a bit lengthy, so bear with me.</p> <h3 id="fixing-last-weeks-problems"> <a href="#fixing-last-weeks-problems" class="anchor-head"></a> Fixing last week’s problems </h3> <p>After investigating why my simulation was crashing when local costmap was set, I finally found the reason.</p> <p>The usual suspect: Gazebo <img src="assets/blog-images/week-12/always-has-been-meme.jpeg" alt="No gazebo devs, I don't blame you. The fault was in my config" /></p> <p>Gazebo didn’t publish the clock, which made everything useless as <code class="highlighter-rouge">use_sim_time</code> was set to true. A quick fix in my config launch file and this was okay. But it didn’t solve everything.</p> <p>The second problem was the map itself. When robot travelled in our old warehouse world, it always used to travel more than that shown in RViz, which I don’t fully understand why. (My guess: The old map was huge and this might have added a lot of latency between Navigation2 output and response from Gazebo). This meant that it always used to miss the goals/ crash into objects, even with valid costmaps. After considering every option that I had at this time ( we will have a discussion about SLAM and map later in this blog), I went with selecting a completely new world where navigation works quite predictably. One added benefit: This world is actually from amazon! It is the <a href="https://github.com/aws-robotics/aws-robomaker-small-warehouse-world">warehouse world from aws</a>, <a href="https://github.com/shreyasgokhale/aws-robomaker-small-warehouse-world">ported and modified</a> by me a bit to suit our purpose. It has some real life warehouse elements to it: Stray piles of boxes, big trays to keep stock etc. It is not perfect, but usable for now.</p> <p>After tweaking some navigation parameters, everything seemed to work okay-ish. Phew.. Now we have Single and Multi robot exercises in ROS2 almost ready! After finishing up the walkthroughs, they will be published shortly on the Jderobot Academy website. For now, here is a sneak preview of what the warehouse and robot looks like:</p> <div class="embed-container"> <iframe src="https://www.youtube.com/embed/RxAlkDKQ23Y" width="700" height="480" frameborder="0" allowfullscreen=""> </iframe> </div> <p>Before we rush to try it out, let’s go back to the basics and try to understand how the exercise is structured around.</p> <h2 id="single-amazon-robot-package"> <a href="#single-amazon-robot-package" class="anchor-head"></a> Single amazon robot package </h2> <p>If we look at our directory structure, we will see following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── amazon_robot_bringup
├── amazon_robot_controller
├── amazon_robot_description
├── amazon_robot_gazebo
├── amazon_robot_msg
├── amazon_robot_rviz_plugins
├── aws-robomaker-small-warehouse-world
├── docker
├── docker-compose.yaml
├── README.md
└── start_simulation.sh
</code></pre></div></div> <p>As we discussed the last time, the <code class="highlighter-rouge">amazon_robot_controller</code> is the heart of our operations. But what about other packages?</p> <p><code class="highlighter-rouge">amazon_robot_bringup</code> holds the startup scripts. We will come back to this later</p> <p><code class="highlighter-rouge">amazon_robot_description</code> has <code class="highlighter-rouge">.urdf</code> files which are used by <code class="highlighter-rouge">robot_state_publisher</code> . Robot states are quite important as every link and joint in the robot is described in some relation with other links and joints, ultimately coming back to the <code class="highlighter-rouge">base_link</code> .</p> <p><code class="highlighter-rouge">amazon_robot_gazebo</code> has <code class="highlighter-rouge">.sdf</code> models of our robot and also other objects. These files are used by gazebo to simulate a robot, it’s sensors, other objects etc. These files also simulate behaviours, for example actuation behaviour of prismatic joint in our amazon robot. They are quite important if you are creating a robot by yourself but for now, we just have to keep in mind that we are using <code class="highlighter-rouge">amazon_robot2</code> as our model.</p> <p><code class="highlighter-rouge">amazon_robot_msg</code> are custom ros messages. In our case, this describes the action message <code class="highlighter-rouge">FollowTargets</code> that we use to send targets to our robot.</p> <p><code class="highlighter-rouge">amazon_robot_rviz_plugins</code> are, as the name suggests, rviz plugins which describe our rviz window. We are going to use rviz for setting initial pose, sending goals, sending waypoints and this library handles it.</p> <p><code class="highlighter-rouge">aws-robomaker-small-warehouse-world</code> is a new addition. When experimenting, we noticed that our old warehouse map model doesn’t give correct results with Navigation2. Hence, we tried to swap it with a brand new world from actual amazon itself. It was released just a month ago and it is quite a faithful representation. We have modified it with our pallets and it is suitable for both: single and multi robot exercise.</p> <p><code class="highlighter-rouge">docker</code> is for all the docker related files.</p> <p>Yes, both NVIDIA and Intel are supported. Nvidia guys, just run the following command</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xhost +<span class="s2">"local:docker@"</span>
<span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-e</span> <span class="nv">DISPLAY</span><span class="o">=</span><span class="nv">$DISPLAY</span>  <span class="nt">-v</span> <span class="nv">$XSOCK</span>:<span class="nv">$XSOCK</span>  <span class="nt">-v</span> <span class="nv">$HOME</span>/.Xauthority:/root/.Xauthority  <span class="nt">--privileged</span>  <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--gpus</span> all amazon_robot_amazon-exercise:latest /bin/bash
</code></pre></div></div> <hr /> <p>Now that we know the overall architecture, I want to explain to you what happens when you launch an exercise using one of the bringup files.</p> <p>Let’s take an example of <code class="highlighter-rouge">amazon_robot_in_aws_world.py</code> file (<code class="highlighter-rouge">amazon_robot/amazon_robot_bringup/bringup/launch/amazon_robot_in_aws_world.py</code> ) which we use to launch the single robot exercise:</p> <p>First few lines are basic imports and declaration of parameters.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="c1"># Use Simulation time from gazebo
</span>    <span class="n">use_sim_time</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'use_sim_time'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'true'</span><span class="p">)</span>

		<span class="c1"># Our bringup location
</span>    <span class="n">amazon_gazebo_package_dir</span> <span class="o">=</span> <span class="n">get_package_share_directory</span><span class="p">(</span><span class="s">'amazon_robot_gazebo'</span><span class="p">)</span>
    <span class="n">amazon_gazebo_package_launch_dir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">amazon_gazebo_package_dir</span><span class="p">,</span> <span class="s">'launch'</span><span class="p">)</span>
    
    <span class="n">amazon_description_dir</span> <span class="o">=</span> <span class="n">get_package_share_directory</span><span class="p">(</span><span class="s">'amazon_robot_description'</span><span class="p">)</span>
    <span class="n">this_launch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="o">....</span>

<span class="c1"># Create the launch configuration variables
</span>    <span class="n">slam</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'slam'</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'namespace'</span><span class="p">)</span>
    <span class="n">use_namespace</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'use_namespace'</span><span class="p">)</span>
    <span class="n">map_yaml_file</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'map'</span><span class="p">)</span>
    <span class="n">use_sim_time</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s">'use_sim_time'</span><span class="p">)</span>

<span class="o">...</span>
</code></pre></div></div> <p>Notice how we are mentioning our own custom packages. Now we come to some important lines</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Map
</span>    <span class="n">declare_map_yaml_cmd</span> <span class="o">=</span> <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="s">'map'</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">amazon_bringup_package_dir</span><span class="p">,</span> <span class="s">'maps'</span><span class="p">,</span> <span class="s">'aws_warehouse'</span> <span class="p">,</span><span class="s">'map.yaml'</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s">'Full path to map file to load'</span><span class="p">)</span>
</code></pre></div></div> <p>This launches our pre made map. This <code class="highlighter-rouge">map.yaml</code> / <code class="highlighter-rouge">map.pgm</code> file is 2D gridmap representation of our environment. In an unknown environment, we can use SLAm ang generate our own map.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">declare_params_file_cmd</span> <span class="o">=</span> <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="s">'params_file'</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">amazon_bringup_package_dir</span><span class="p">,</span> <span class="s">'params'</span><span class="p">,</span> <span class="s">'nav2_params_with_control.yaml'</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s">'Full path to the ROS2 parameters file to use for all launched nodes'</span><span class="p">)</span>
</code></pre></div></div> <p>This is our parameter file for navigation2, located at <code class="highlighter-rouge">amazon_robot/amazon_robot_bringup/bringup/params/nav2_params_with_control.yaml</code> . It looks something like this</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">amcl</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="bp">True</span>
    <span class="n">alpha1</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha2</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha3</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha4</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">alpha5</span><span class="p">:</span> <span class="mf">0.2</span>
    <span class="n">base_frame_id</span><span class="p">:</span> <span class="s">"base_footprint"</span>
    <span class="n">beam_skip_distance</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">beam_skip_error_threshold</span><span class="p">:</span> <span class="mf">0.9</span>
    <span class="n">beam_skip_threshold</span><span class="p">:</span> <span class="mf">0.3</span>
    <span class="n">do_beamskip</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">global_frame_id</span><span class="p">:</span> <span class="s">"map"</span>
    <span class="n">lambda_short</span><span class="p">:</span> <span class="mf">0.1</span>

<span class="o">...</span>

<span class="n">controller_server</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="bp">True</span>
    <span class="n">controller_frequency</span><span class="p">:</span> <span class="mf">20.0</span>
    <span class="n">min_x_velocity_threshold</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="n">min_y_velocity_threshold</span><span class="p">:</span> <span class="mf">0.5</span>
    <span class="n">min_theta_velocity_threshold</span><span class="p">:</span> <span class="mf">0.001</span>
    <span class="n">progress_checker_plugin</span><span class="p">:</span> <span class="s">"progress_checker"</span>
    <span class="n">goal_checker_plugin</span><span class="p">:</span> <span class="s">"goal_checker"</span>
    <span class="n">controller_plugins</span><span class="p">:</span> <span class="p">[</span><span class="s">"FollowPath"</span><span class="p">]</span>

<span class="o">...</span>

<span class="n">robot_controller</span><span class="p">:</span>
  <span class="n">ros__parameters</span><span class="p">:</span>
    <span class="n">use_sim_time</span><span class="p">:</span> <span class="bp">True</span>
    <span class="n">controller_bt_xml_filename</span><span class="p">:</span> <span class="s">"follow_waypoints_and_load.xml"</span>
    <span class="n">plugin_lib_names</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">nav2_wait_action_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_recovery_node_bt_node</span>
    <span class="o">-</span> <span class="n">nav2_navigate_to_pose_action_bt_node</span>
    <span class="o">-</span> <span class="n">amazon_robot_get_next_goal_action_bt_node</span>
    <span class="o">-</span> <span class="n">amazon_robot_all_goals_achieved_condition_bt_node</span>
    <span class="o">-</span> <span class="n">amazon_robot_load_pallet_action_bt_node</span>

</code></pre></div></div> <p>This file is basically a representation of all the buttons of various components of the navigation stack that you can tweak. You can set the publish frequency high to update maps faster on the cost of higher compute power or set if either Lidar or 2d Pointcloud is used for creating costmap. For more information, have a look at the navigation2 documentation where the parameters are described quite neatly.</p> <p>Did you notice the last <code class="highlighter-rouge">robot_controller</code> node? That is our own custom robot controller node with it’s own parameters. For example, in multirobot exercise, I send the robot name to the controller using <code class="highlighter-rouge">robot_name: "robot2"</code> parameter. It also specifies what behaviour tree is going to be used by our controller. In our case it is <code class="highlighter-rouge">follow_waypoints_and_load.xml</code>. So, how does it look like?</p> <p>The file, located at <code class="highlighter-rouge">amazon_robot/amazon_robot_controller/behavior_trees/follow_waypoints_and_load.xml</code> describes how our robot is going to function. We have already discussed how behaviour trees work with nav2, but let’s go through our demo.</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;root</span> <span class="na">main_tree_to_execute=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;BehaviorTree</span> <span class="na">ID=</span><span class="s">"MainTree"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ReactiveFallback</span> <span class="na">name=</span><span class="s">"FollowTargets"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;AllGoalsAchieved</span> <span class="na">goal_achieved=</span><span class="s">"{goal_achieved}"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;KeepRunningUntilFailure&gt;</span>
        <span class="nt">&lt;ReactiveSequence&gt;</span>
          <span class="nt">&lt;GetNextGoal</span> <span class="na">goals=</span><span class="s">"{goals}"</span> <span class="na">goal=</span><span class="s">"{goal}"</span> <span class="na">goal_achieved=</span><span class="s">"{goal_achieved}"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;NavigateToPose</span> <span class="na">goal=</span><span class="s">"{goal}"</span> <span class="na">server_name=</span><span class="s">"navigate_to_pose"</span> <span class="na">server_timeout=</span><span class="s">"10"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;LoadPallet</span> <span class="na">load_queue=</span><span class="s">"{load_queue}"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;SetBlackboard</span> <span class="na">output_key=</span><span class="s">"goal_achieved"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/ReactiveSequence&gt;</span>
      <span class="nt">&lt;/KeepRunningUntilFailure&gt;</span>
    <span class="nt">&lt;/ReactiveFallback&gt;</span>
  <span class="nt">&lt;/BehaviorTree&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</code></pre></div></div> <p>Our main node is <code class="highlighter-rouge">FollowTargets</code>, which is also the name of our ros action. <code class="highlighter-rouge">FollowTargets</code> runs until our goals are complete. If we open our tree in <a href="https://github.com/BehaviorTree/Groot">Groot</a>, it looks like following:</p> <p><img src="assets/blog-images/week-12/behaviour-tree.png" alt="Behaviour Tree" /></p> <p>The tree structure is quite explanatory by itself. It follows the execution from left to right. We start executing waypoints one by one. <code class="highlighter-rouge">NavigateToPose</code> loads its own subtree to compute path to a pose and navigate to it. Once it reaches at the destination, <code class="highlighter-rouge">LoadPallet</code> node is activated and it loads or unloads our lift. We can also edit the BT structure, the way we want. For example, if we need more waiting time, we can add <code class="highlighter-rouge">&lt;Wait wait_duration="5"/&gt;</code> to the tags, and so on. More on that in the next blog.</p> <p>Coming back to our launch script, now we are actually going to launch some nodes</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">start_gazebo_server_cmd</span> <span class="o">=</span> <span class="n">ExecuteProcess</span><span class="p">(</span>
        <span class="n">condition</span><span class="o">=</span><span class="n">IfCondition</span><span class="p">(</span><span class="n">use_simulator</span><span class="p">),</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s">'gzserver'</span><span class="p">,</span> <span class="s">'--verbose'</span><span class="p">,</span> <span class="s">'-s'</span><span class="p">,</span> <span class="s">'libgazebo_ros_init.so'</span><span class="p">,</span> <span class="s">'-s'</span> <span class="p">,</span> <span class="s">'libgazebo_ros_factory.so'</span><span class="p">,</span> <span class="s">'-s'</span> <span class="p">,</span> <span class="s">'libgazebo_ros_force_system.so'</span> <span class="p">,</span> <span class="n">world</span><span class="p">],</span>
        <span class="n">cwd</span><span class="o">=</span><span class="p">[</span><span class="n">this_launch_dir</span><span class="p">],</span> <span class="n">output</span><span class="o">=</span><span class="s">'screen'</span><span class="p">)</span>
</code></pre></div></div> <p>The plugins are <code class="highlighter-rouge">libgazebo_ros_init.so</code> for initializing clock (Yes! that was the missing part from last week’s exercise), <code class="highlighter-rouge">libgazebo_ros_factor.so</code> for spawning robot and <code class="highlighter-rouge">libgazebo_ros_force_system.so</code> for applying joint force on our prismatic joint.</p> <p>After this, make a choice, should we run SLAM or should we run the localization</p> <p><img src="https://media.giphy.com/media/1CNsm9ZkHF0m4/source.gif" alt="" /></p> <p>Well, it is not so straightforward. For our exercise, we are moving things around. And not just some tiny stuff, big pallets which are almost 4 times the size of our robot. Hence, moving will affect our map in a big way. Usually, when we use static maps for localization, the objects in the map are fixed. Hence, if we move something, and it is still represented at it’s old position in the map, the <code class="highlighter-rouge">amcl</code> localizer won’t be much happy with this. The particle swarm is much dispersed and we can lose lock on our current position and get thrown away in some random corner of the map. This is exactly what happens sometimes now.</p> <p>But if we want to use SLAM in ROS2, there is no other reliable package available than SLAM Toolbox. However, currently there are some issues with the LIDAR driver that we are using (rplidar from tb3 😪), so we can’t use that either. So we are stuck using some static map with localization and hope for the best that it works. We go ahead and load up the localization script, which loads the aws world that we described previously.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bringup_cmd <span class="o">=</span> IncludeLaunchDescription<span class="o">(</span>
        PythonLaunchDescriptionSource<span class="o">(</span>os.path.join<span class="o">(</span>amazon_bringup_package_dir, <span class="s1">'launch'</span>, <span class="s1">'bringup_launch.py'</span><span class="o">))</span>,
        <span class="nv">launch_arguments</span><span class="o">={</span><span class="s1">'namespace'</span>: namespace,
                          <span class="s1">'use_namespace'</span>: use_namespace,
                          <span class="s1">'slam'</span>: slam,
                          <span class="s1">'map'</span>: map_yaml_file,
                          <span class="s1">'use_sim_time'</span>: use_sim_time,
                          <span class="s1">'params_file'</span>: params_file,
                          <span class="s1">'default_bt_xml_filename'</span>: default_bt_xml_filename,
                          <span class="s1">'autostart'</span>: autostart<span class="o">}</span>.items<span class="o">())</span>
</code></pre></div></div> <p>Now the only thing left for us to do is spawn our robot! Keep in mind that namespacing and renaming the topics is handled by this script and you have to make sure that we are not duplicating any topics/actions/services when launching two robots</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spawn_robot_cmd <span class="o">=</span> IncludeLaunchDescription<span class="o">(</span>
                PythonLaunchDescriptionSource<span class="o">(</span>os.path.join<span class="o">(</span>amazon_bringup_package_dir, <span class="s1">'launch'</span>,
                                                        <span class="s1">'spawn_tb3_launch.py'</span><span class="o">))</span>,
                <span class="nv">condition</span><span class="o">=</span>IfCondition<span class="o">(</span>spawn_robot<span class="o">)</span>,
                <span class="nv">launch_arguments</span><span class="o">={</span>
                                <span class="s1">'x_pose'</span>: <span class="s1">'0'</span>,
                                <span class="s1">'y_pose'</span>: <span class="s1">'0'</span>,
                                <span class="s1">'z_pose'</span>: <span class="s1">'0'</span>,
                                <span class="s1">'robot_name'</span>: <span class="s1">'amazon_robot'</span>
                                <span class="o">}</span>.items<span class="o">())</span> 
</code></pre></div></div> <p>Boom! Soon enough our robots will be yeeted in the warehouse world, ready to be initialized and tasked. In case of multi-robot, two navigation stacks will be launched. You can see more details about how this looks in the last blog! Feel free to explore related scripts and parameters in order to understand more about the system.</p> <p>Now, because you stuck with me for the entirety of this blog, I have a little surprize for you. Here is the video two robots, in our warehouse, collaborating with each other in a plan (and failing miserably in the end!). But the system is working exactly as it is expected to do.</p> <div class="embed-container"> <iframe src="https://www.youtube.com/embed/PTdZGqW39xE" width="700" height="480" frameborder="0" allowfullscreen=""> </iframe> </div> <p>In the next blog, the exercises will be introduced and will be demonstrated! Until then!</p> <p><strong><em>いって来ます!</em></strong></p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/colab-gsoc2020-Shreyas_Gokhale/behaviour-trees" > <div class="nav-arrow">Previous</div> <span class="post-title">Behaviour Trees</span> </a> <a class="post-nav-item post-nav-next" href="/colab-gsoc2020-Shreyas_Gokhale/phase-three-report"> <div class="nav-arrow">Next</div> <span class="post-title">Evaluation 3 Report</span> </a> </nav> </div> <footer class="footer"> <a class="footer_item" href="https://github.com/shreyasgokhale">github</a> <a class="footer_item" href="https://www.linkedin.com/in/shreyas6gokhale/">linkedin</a> <a class="footer_item" href="https://www.instagram.com/elementaryshr/">instagram</a> <a class="footer_item" href="https://shreyasgokhale.com/">blog</a> <a class="footer_item" href="https://www.shreyasgokhaleresu.me/">portfolio</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2020</span> <small class="footer_theme-copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a> theme | modified by <a href="https://shreyasgokhale.com/" target="_blank" rel="noreferrer noopener" >shreyas</a> </small> </footer> <script src="/colab-gsoc2020-Shreyas_Gokhale/assets/js/main.js" defer="defer"></script> <script src="/colab-gsoc2020-Shreyas_Gokhale/assets/js/galite.js"></script> <script> var galite = galite || {}; galite.UA = "UA-126403543-4"; </script> </body> </html>
